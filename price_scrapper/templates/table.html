<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="fonts/icomoon/style.css">

    <link rel="stylesheet" href="../static/owl.carousel.min.css">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../static/bootstrap.min.css">
    
    <!-- Style -->
    <link rel="stylesheet" href="../static/style.css">

    <title>Price scrapper table</title>
      <!-- Change this page style here -->
    <style>
    
    </style>
  </head>
  <body>
  <div class="content">


    <div class="container">

    <button class="my-btn my-btn-class-31" id="updateProductListBtn" >Update Product List</button>

    <button class="my-btn my-btn-class-31" id="scrapAll">Scrap All</button>

    <button class="my-btn my-btn-class-31" id="webPriceUpdate">Update Web Prices</button>


      <div class="table-responsive custom-table-responsive">
        <table class="table custom-table">
          {% csrf_token %}
          <thead>
            <tr>  
              
              <th scope="col">ID</th>
              <th scope="col">Name</th>
              <th scope="col">Link</th>
              <th scope="col">Status</th>
              <th scope="col">Last Price Update</th>ss
              <th scope="col">Last scraped</th>
              <th scope="col">Price</th>
              <th scope="col">Action</th>
            </tr>
          </thead>
          
          <tbody>
             {% for p in products %}
            <tr scope="row">
              <td>
                {{p.id}}
              </td>
              <td><a href="#">{{p.name}}</a></td>
              <td style="width: 300px;">
                <input
                    id = "targetLink_{{p.id}}"
                    type="text"
                    class="target-link-input"
                    value="{{ p.target_link }}"
                  />
              </td>
              <td>{{p.crawl_status}}</td>
              <td>{{p.last_web_price_update}}</td>
              <td>{{p.last_scrape}}</td>
              <td>{{p.price}}</td>
              <td>
               <button class="btn btn-primary"  onclick= updateProduct({{ p.id }}) >confirm</button>
              </td>
            </tr>
            <tr class="spacer"><td colspan="100"></td></tr>
            
            {% endfor %}
          </tbody>
        
        </table>
      </div>

    </div>

  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
    $(document).ready(function() {
        $("#updateProductListBtn").click(function() {
            $.ajax({
                url: "{% url 'update-product-list' %}",  // URL of your Django view
                type: "GET",
                success: function(data) {
                    // Handle the success response here
                    if (data === true) {
                        // Refresh the page upon success
                        location.reload();
                    } else {
                        // Handle any other response if needed
                        alert("Update failed.");
                    }
                },
                error: function() {
                    // Handle errors here
                    alert("Error occurred during the update.");
                }
            });
        });
    });


    $(document).ready(function() {
        $("#scrapAll").click(function() {
            $.ajax({
                url: "{% url 'scrape_prices' %}",  // URL of your Django view
                type: "GET",
                success: function(data) {
                    // Handle the success response here
                    if (data['message'] === 'Success') {
                        // Refresh the page upon success

                        alert("Update Success.");
                        location.reload();
                    } else {
                        // Handle any other response if needed
                        alert("Update failed.");
                    }
                },
                error: function() {
                    // Handle errors here
                    alert("Error occurred during the update.");
                }
            });
        });
    });


    $(document).ready(function() {
        $("#webPriceUpdate").click(function() {
            $.ajax({
                url: "{% url 'web-prices' %}",  // URL of your Django view
                type: "GET",
                success: function(data) {
                    // Handle the success response here
                    if (data === true) {
                        // Refresh the page upon success
                        location.reload();
                    } else {
                        // Handle any other response if needed
                        alert("Update failed.");
                    }
                },
                error: function() {
                    // Handle errors here
                    alert("Error occurred during the update.");
                }
            });
        });
    });

    function updateProduct(productId) {
        // Get the updated target link from the input field
        const confirmed = confirm("Are you sure you want to update this product?");

        // Check the user's choice
        if (confirmed) {
          // User clicked "OK," proceed with the update
          const updatedTargetLink = $(`#targetLink_${productId}`).val();
          const data = {
          csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
          product_id: productId,
          target_link: updatedTargetLink,
        };

          $.ajax({
                url: "{% url 'ajax-update-target-link' %}",  // URL of your Django view
                type: "POST",
                data: data,
                success: function (response) {
                  // Handle the success response here
                  if (response.success) {
                    alert("Update successful!");
                    // You can update the UI here if needed
                  } else {
                    alert("Update failed.");
                    // Handle any other response if needed
                  }
                },
                error: function () {
                  // Handle errors here
                  alert("Error occurred during the update.");
                },
        });
        } else {
          alert('not confirmed')
          // User clicked "Cancel," do nothing or provide feedback
          // You can optionally add a message here or take other actions.
        }


       
        // Perform the update using AJAX (you'll need to implement this)
        // You can use productId and updatedTargetLink to send the data to your server
        // ...
      }

    </script>
  </body>
</html>